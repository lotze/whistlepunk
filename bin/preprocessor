#!/usr/bin/env ../node_modules/.bin/coffee

Dispatcher = require '../lib/dispatcher'
BacklogProcessor = require '../lib/backlog_filler'
BacklogProcessor = require '../lib/backlog_processor'
Filter = require '../lib/filter'
FilterStream = require '../lib/filter_stream'


backlogProcessDelay = 1000 * 60 * 60
filterBackwardExpireDelay = 1000 * 60 * 60 * 24
filterForwardExpireDelay = 1000 * 60 * 60 + 1000 * 60 * 5 # extra 5 minute delay from backlogProcessDelay
                                                            # to ensure that users processed in "real time" aren't
                                                            # mistakenly counted as invalid

userValidators    = [javascriptEnabledValidator, loggedInValidator, userAgentValidator]
dispatcher        = new Dispatcher(redis_builder('distillery'))
backlogFiller     = new BacklogFiller(redis_builder('whistlepunk'))
filter            = new Filter(redis_builder('whistlepunk'), filterBackwardExpireDelay, filterForwardExpireDelay, userValidators)
backlogProcessor  = new BacklogProcessor(redis_builder('whistlepunk'), backlogProcessDelay, filter) # pull from some config somewhere

dispatcher.pipe(backlogFiller)
dispatcher.pipe(filter)
backlogProcessorStream = dispatcher.pipe(backlogProcessor)
backlogProcessorStream.pipe(new Logwrite('good.log', true))
backlogProcessorStream.pipe(new RedisWriter(redis_builder('filtered')))
backlogProcessorStream.pipe(new Logwrite('bad.log', false))
