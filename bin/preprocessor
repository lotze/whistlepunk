#!/usr/bin/env ../node_modules/.bin/coffee

Dispatcher = require '../lib/dispatcher'
BacklogProcessor = require '../lib/backlog_filler'
BacklogProcessor = require '../lib/backlog_processor'
Filter = require '../lib/filter'
UserValidator = require '../lib/user_validator'
FilterStream = require '../lib/filter_stream'

dispatcher        = new Dispatcher(redis_builder('distillery'))
backlogFiller     = new BacklogFiller(redis_builder('whistlepunk'))
backlogProcessor  = new BacklogProcessor(dispatcher, redis_builder('filtered'))
userValidator     = new UserValidator(redis_builder('filtered'))
filter            = new Filter(userValidator)
filterStream      = new FilterStream(backlogProcessor, filter)
whistlePunkStream = new RedisListWriter(redis_builder('whistlepunk'))

dispatcher.pipe(backlogFiller)
dispatcher.pipe(filterStream).pipe(whistlePunkStream) # TODO: Need to send "bad" events somewhere
